<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>‚ô†Ô∏è Black Jack Online ‚ô•Ô∏è ‚Äî Hobbyprojekt</title>

  <!-- Firebase -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js";
    import { getFirestore, doc, setDoc, getDoc, getDocs, collection, deleteDoc } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore.js";

    // üîß Eigene Firebase-Konfiguration eintragen
    const firebaseConfig = {
      apiKey: "AIzaSyBi1AejurQ9HJk_zPIS_GGruV9iuHMB8-8",
      authDomain: "blackjackonline-def9e.firebaseapp.com",
      projectId: "blackjackonline-def9e",
      storageBucket: "blackjackonline-def9e.firebasestorage.app",
      messagingSenderId: "94188053463",
      appId: "1:94188053463:web:810ef7fb8b9f80e602e192"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    // --- Globale Variablen ---
    let playerHand = [], dealerHand = [], points = 100, currentUser = null, standBlocked = false;
    const fullDeck = [2,2,2,2,3,3,3,3,4,4,4,4,5,5,5,5,6,6,6,6,7,7,7,7,8,8,8,8,9,9,9,9,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,10,11,11,11,11];
    let cards = [...fullDeck];

    // Firestore Funktionen
    async function saveUserData(username, points) {
      await setDoc(doc(db, "blackjackUsers", username), { points: points });
    }
    async function loadUserData(username) {
      const ref = doc(db, "blackjackUsers", username);
      const snap = await getDoc(ref);
      if (snap.exists()) {
        return snap.data().points;
      } else {
        await setDoc(ref, { points: 100 });
        return 100;
      }
    }
    async function deleteUser(username) {
      await deleteDoc(doc(db, "blackjackUsers", username));
    }
    async function getLeaderboard() {
      const usersRef = collection(db, "blackjackUsers");
      const snap = await getDocs(usersRef);
      const list = [];
      snap.forEach(doc => list.push({ name: doc.id, points: doc.data().points }));
      return list.sort((a,b)=>b.points - a.points);
    }

    // --- UI Elemente ---
    const loginScreen=document.getElementById("loginScreen"),
          gameScreen=document.getElementById("gameScreen"),
          leaderboardScreen=document.getElementById("leaderboardScreen"),
          message=document.getElementById("message"),
          dealerBox=document.getElementById("dealer-box"),
          playerBox=document.getElementById("player-box"),
          pointsBox=document.getElementById("points"),
          welcomeUser=document.getElementById("welcomeUser");

    // --- Login ---
    document.getElementById("loginBtn").onclick=async function(){
      const name=document.getElementById("username").value.trim();
      if(!name){alert("Bitte gib einen Benutzernamen ein.");return;}
      const safe=name.replace(/</g,"&lt;").replace(/>/g,"&gt;").slice(0,30);
      currentUser=safe;
      points=await loadUserData(safe);
      showGameScreen();
    };

    function showGameScreen(){
      loginScreen.style.display="none";
      leaderboardScreen.style.display="none";
      gameScreen.style.display="block";
      welcomeUser.textContent=`üëã Willkommen, ${currentUser} ‚Äî (Hobbyprojekt)`;
      updateUI();
    }

    document.getElementById("logoutBtn").onclick=function(){
      currentUser=null; playerHand=[]; dealerHand=[];
      gameScreen.style.display="none"; loginScreen.style.display="block";
    };

    function drawCard(){ if(cards.length===0) cards=[...fullDeck]; const i=Math.floor(Math.random()*cards.length); return cards.splice(i,1)[0]; }
    function sum(h){ return h.reduce((a,b)=>a+b,0); }

    document.getElementById("deal").onclick=function(){
      if(points<10){message.textContent="‚ö†Ô∏è Zu wenig Punkte.";return;}
      standBlocked=false; points-=10; cards=[...fullDeck];
      playerHand=[drawCard(),drawCard()]; dealerHand=[drawCard(),drawCard()];
      dealerBox.style.display="none"; message.textContent="Neue Runde! üçÄ";
      updateUI();
    };
    document.getElementById("hit").onclick=function(){
      if(playerHand.length===0){message.textContent="Dr√ºcke zuerst Deal.";return;}
      playerHand.push(drawCard()); updateUI();
      if(sum(playerHand)>21) message.textContent="üí• Bust!";
    };
    document.getElementById("stand").onclick=function(){
      if(standBlocked||playerHand.length===0){message.textContent="Dr√ºcke zuerst Deal.";return;}
      standBlocked=true; while(sum(dealerHand)<17) dealerHand.push(drawCard());
      const ps=sum(playerHand), ds=sum(dealerHand);
      if(ds>21) message.textContent="üèÜ Dealer bust! Du gewinnst!";
      else if(ps>21) message.textContent="üí• Bust!";
      else if(ps>ds) message.textContent="üéâ Du gewinnst!";
      else if(ps<ds) message.textContent="‚ùå Dealer gewinnt.";
      else message.textContent="ü§ù Unentschieden!";
      if(ps<=21){ if(ds>21||ps>ds) points+=30; else if(ps===ds) points+=10; }
      dealerBox.textContent=`ü§ñ Dealer: ${dealerHand.join(", ")} (Summe: ${ds})`;
      dealerBox.style.display="block"; updateUI();
    };

    function updateUI(){
      playerBox.textContent=`üßç Spieler: ${playerHand.join(", ")} (Summe: ${sum(playerHand)||0})`;
      pointsBox.textContent=`üí∞ Punkte: ${points}`;
      if(currentUser) saveUserData(currentUser, points);
    }

    document.getElementById("resetPoints").onclick=function(){
      if(confirm("Punkte auf 100 zur√ºcksetzen?")){points=100;updateUI();}
    };

    document.getElementById("leaderboardBtn").onclick=async function(){
      gameScreen.style.display="none"; leaderboardScreen.style.display="block";
      const list=await getLeaderboard();
      let html="<ol class='leader'>";
      list.forEach((u,i)=>{
        let medal=i===0?"ü•á":i===1?"ü•à":i===2?"ü•â":"";
        html+=`<li><strong>${u.name}</strong> ‚Äî ${u.points} Punkte ${medal}</li>`;
      });
      html+="</ol><p class='small'>Globale Bestenliste (aus Firestore)</p>";
      document.getElementById("leaderboard").innerHTML=html;
    };
    document.getElementById("backToGame").onclick=function(){
      leaderboardScreen.style.display="none"; showGameScreen();
    };

    document.getElementById("deleteAccount").onclick=async function(){
      if(!currentUser)return;
      if(confirm("Konto und Punkte aus Firestore l√∂schen?")){
        await deleteUser(currentUser);
        currentUser=null;playerHand=[];dealerHand=[];points=100;
        gameScreen.style.display="none";loginScreen.style.display="block";
      }
    };

    // Modal-Steuerung
    const modal=document.getElementById("modalBackdrop");
    function openModal(){modal.style.display="flex";}
    function closeModal(){modal.style.display="none";}
    document.getElementById("openImpressumFooter").onclick=openModal;
    document.getElementById("closeModal").onclick=closeModal;
    modal.addEventListener("click",e=>{if(e.target===modal)closeModal();});
  </script>

  <style>
    :root{--bg:#001a00;--panel:#142814;--accent:#FFD700;--muted:#aaa;}
    body{margin:0;min-height:100vh;display:flex;align-items:center;justify-content:center;background:var(--bg);color:#fff;font-family:Arial,sans-serif;padding:20px;}
    .container{width:100%;max-width:720px;background:var(--panel);border-radius:18px;padding:22px;text-align:center;box-shadow:0 8px 30px rgba(0,0,0,0.6)}
    h1{color:var(--accent);margin:6px 0 10px;font-size:34px}
    button{padding:10px 16px;margin:6px;border:none;border-radius:10px;cursor:pointer;color:#000}
    #deal{background:#228B22}#hit{background:#0066CC}#stand{background:#CC0000}#resetPoints{background:#FF8C00}#leaderboardBtn{background:#4444AA}#deleteAccount{background:#882222}
    footer{position:fixed;bottom:0;left:0;width:100%;text-align:center;font-size:12px;color:var(--muted);background:rgba(0,0,0,0.4);padding:4px 8px;border-top:1px solid rgba(255,255,255,0.1)}
    footer button{background:none;border:none;color:var(--muted);cursor:pointer;font-size:12px;text-decoration:underline}
    .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,0.6);display:none;align-items:center;justify-content:center;padding:20px;z-index:50}
    .modal{background:#0f2610;border-radius:12px;padding:18px;width:100%;max-width:720px;color:#eee;text-align:left;max-height:90vh;overflow:auto}
  </style>
</head>
<body>

  <!-- LOGIN -->
  <div class="container" id="loginScreen">
    <h1>‚ô†Ô∏è Black Jack Online ‚ô•Ô∏è</h1>
    <input id="username" placeholder="Benutzername">
    <button id="loginBtn">Anmelden / Registrieren</button>
    <p class="small">Benutzername & Punkte werden in Firebase Firestore gespeichert.</p>
  </div>

  <!-- SPIEL -->
  <div class="container" id="gameScreen" style="display:none;">
    <h1>‚ô†Ô∏è Black Jack Online ‚ô•Ô∏è</h1>
    <p id="welcomeUser"></p>
    <p id="message">üé≤ Dr√ºcke 'Deal', um zu starten!</p>
    <div class="card-box" id="player-box"></div>
    <div class="dealer-box" id="dealer-box" style="display:none"></div>
    <div class="points" id="points"></div>
    <div class="row">
      <button id="deal">Deal</button>
      <button id="hit">Hit</button>
      <button id="stand">Stand</button>
    </div>
    <div class="row">
      <button id="resetPoints">Punkte auf 100</button>
      <button id="leaderboardBtn">Bestenliste</button>
      <button id="deleteAccount">Konto l√∂schen</button>
      <button id="logoutBtn">Abmelden</button>
    </div>
  </div>

  <!-- LEADERBOARD -->
  <div class="container" id="leaderboardScreen" style="display:none;">
    <h1>üèÜ Bestenliste</h1>
    <div id="leaderboard"></div>
    <button id="backToGame">Zur√ºck</button>
  </div>

  <!-- MODAL: Impressum & Datenschutz -->
  <div class="modal-backdrop" id="modalBackdrop">
    <div class="modal">
      <h3>Impressum & Datenschutz</h3>
      <p><b>Verantwortlicher:</b><br>Hannes G√ºnther<br>D√∂rnfeld an der Heide 54F 07426 K√∂nigsee <br>Deutschland<br>E-Mail: hg.koenigsee@gmail.com<br>Privates, nicht-kommerzielles Projekt.</p>
      <h4>Zweck</h4>
      <p>Diese Website dient ausschlie√ülich der Unterhaltung (Blackjack ohne Echtgeld).</p>
      <h4>Datenverarbeitung mit Firebase Firestore</h4>
      <p>Zur Speicherung der Benutzerpunkte und -namen wird Google Firebase Firestore verwendet (Anbieter: Google Ireland Limited, Dublin, Irland).</p>
      <ul>
        <li>Gespeicherte Daten: Benutzername, Punktestand</li>
        <li>Zweck: Darstellung von Punktest√§nden & Bestenlisten</li>
        <li>Keine Weitergabe an Dritte</li>
        <li>L√∂schung jederzeit √ºber ‚ÄûKonto l√∂schen‚Äú m√∂glich</li>
      </ul>
      <p>Weitere Infos: <a href="https://firebase.google.com/support/privacy" target="_blank">Firebase Privacy</a></p>
      <button id="closeModal">Schlie√üen</button>
    </div>
  </div>

  <footer>
    ¬© Privates Hobbyprojekt ‚Äî kein Echtgeld ¬∑ 
    <button id="openImpressumFooter">Impressum & Datenschutz</button>
  </footer>

</body>
</html>

